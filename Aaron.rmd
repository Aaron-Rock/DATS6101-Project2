---
title: "Aaron Project 2"
author: "Aaron Rock"
date: "2022-10-19"
output: html_document
---
```{r init, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
library(ezids)
library(gmodels)
library(ggplot2)
library(dplyr)
install.packages("matrixStats")
library(matrixStats)
library(corrplot)
library(FNN)
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```


```{r}
#First, load the file
online = data.frame(read.csv("online_shoppers_intention.csv"))
original_online = data.frame(read.csv("online_shoppers_intention.csv"))
head(online)

```
```{r, results='hide'}
# Handling categorical variables prior to plotting
online$Month = as.factor(online$Month)
online$Revenue = as.factor(online$Revenue)
online$Weekend = as.factor(online$Weekend)
online$VisitorType = as.factor(online$VisitorType)
```

``` {r}
monthFrequency = ggplot(online, aes(x=Month, color=Month, fill=Month)) + geom_bar()
monthFrequency
userCount = ggplot(online, aes(x=VisitorType, color=VisitorType, fill=VisitorType)) + geom_bar()
userCount
revCount = ggplot(online, aes(x=Revenue, color=Revenue, fill=Revenue)) + geom_bar()
revCount
revTrue = subset(online, online$Revenue == TRUE)
revFalse = subset(online, online$Revenue == FALSE)
pieNum <- c(nrow(revTrue), nrow(revFalse))
piepercent<- round(100*pieNum/sum(pieNum), 1)
pie(pieNum, labels = piepercent, main = "Revenue Percentages",col = rainbow(length(pieNum)))
legend("topright", c("True","False"), cex = 0.8, fill = rainbow(length(pieNum)))
```
```{r}
# Special Day data
specialDay = ggplot(online, aes(SpecialDay)) + geom_density(color="darkblue", fill="lightblue")
specialDay
# scatterSpecialDay = ggplot(online, aes(Revenue, SpecialDay)) + geom_violin(), this plot had no significance
```

```{r}
adminDur = ggplot(online, aes(Administrative_Duration, color=Revenue, fill=Revenue)) + geom_histogram(bins=30)
adminDur
infoDur = ggplot(online, aes(Informational_Duration, color=Revenue, fill=Revenue)) + geom_histogram(bins=30)
infoDur
prodDur = ggplot(online, aes(ProductRelated_Duration, color=Revenue, fill=Revenue)) + geom_histogram(bins=30)
prodDur
```

```{r}
# Bounce Rate is measured by total one page visits divided by total visits 
bounceBox = ggplot(online, aes(BounceRates)) + geom_boxplot(color='blue')
bounceBox
# Exit Rate is measured by total exits from page divided by total visits to page
exitBox = ggplot(online, aes(ExitRates)) + geom_boxplot(color='orange')
exitBox
```
The average Bounce Rate for this site is `r mean(online$BounceRates)*100`%.
The average Exit Rate for this site is `r mean(online$ExitRates)*100`%.

For our dataset it would be better to see individual page exit and bounce rates. The column variables Exit and Bounce Rates are the average of these metrics over each page on this site.


```{r}
online_new = subset(online, select = -c(VisitorType, Month))
online_new$Weekend = as.numeric(online_new$Weekend)
online_new$Revenue = as.numeric(online_new$Revenue)
corrOnline <- cor(online_new)
corrplot(corrOnline, method="number",number.cex=0.5,tl.cex=.6)
```


```{r}
monthTable = xtabs( ~ Revenue + Month, data = online)
monthTable
chisqMonth = chisq.test(monthTable)
chisqMonth
```

```{r}
specialDayTable = xtabs( ~ Revenue + SpecialDay, data = online)
specialDayTable
chisqSD = chisq.test(specialDayTable)
chisqSD
```

```{r, results='hide'}
# Rehandle
online$VisitorType = as.factor(online$VisitorType)
online$Weekend = as.integer(online$Weekend)
online$OperatingSystems = as.integer(online$OperatingSystems)
online$Browser = as.integer(online$Browser)
online$TrafficType = as.integer(online$TrafficType)
online$Region = as.integer(online$Region)
online$Month = as.integer(factor(online$Month, levels = month.abb))
online = subset(online, select=-c(VisitorType))
online = drop_na(online)
```

```{r}
scaledOnline <- as.data.frame(scale(online[1:16], center = TRUE, scale = TRUE))
```

```{r}
set.seed(1000)
online_sample <- sample(2, nrow(scaledOnline), replace=TRUE, prob=c(0.80, 0.20))
```


```{r}
online_training <- scaledOnline[online_sample==1, 1:16]
online_test <- scaledOnline[online_sample==2, 1:16]
```


```{r}
online_trainLabels <- online[online_sample==1, 17]
online_testLabels <- online[online_sample==2, 17]
```

```{r, results='hide'}
online_pred <- knn(train = online_training, test = online_test, cl=online_trainLabels, k=7)
online_pred
```

```{r results='markup'}
onlineCrossTable <- CrossTable(online_testLabels, online_pred, prop.chisq = FALSE)
```  

```{r}
for (kval in 5:15) {
  iris_pred <- knn(train = online_training, test = online_test, cl=online_trainLabels, k=kval)
  onlinePREDCross <- CrossTable(online_testLabels, online_pred, prop.chisq = FALSE)
  print( paste("k = ", kval) )
  onlinePREDCross
  # 
  cm = confusionMatrix(online_pred, reference = online_testLabels ) # from caret library
  # print.confusionMatrix(cm)
  # 
  cmaccu = cm$overall['Accuracy']
  print( paste("Total Accuracy = ", cmaccu ) )
  # print("Other metrics : ")
  # print(cm$byClass)
  # 
  cmt = data.frame(k=kval, Total.Accuracy = cmaccu, row.names = NULL ) # initialize a row of the metrics 
  # cmt = cbind( cmt, data.frame( t(cm$byClass) ) ) # the dataframe of the transpose, with k valued added in front
  ResultDf = rbind(ResultDf, cmt)
  print( xkabledply(   as.matrix(cm), title = paste("ConfusionMatrix for k = ",kval ) ) )
  print( xkabledply(data.frame(cm$byClass), title=paste("k = ",kval)) )
}
``` 

```{r, results='markup'}
xkabledply(ResultDf, "Total Accuracy Summary")
```

